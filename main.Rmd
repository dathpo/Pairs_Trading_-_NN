---
title: "R Notebook"
output: html_notebook
---
```{r}
library(quantmod)
library(ggplot2)
library(scales)
library(reshape2)
library(proxy)
library(MLmetrics)
```
```{r}
tickers <- c("VOO",
             "QQQ",
             "GLD",
             "EEM",
             "VTI",
             "IVV",
             "VEA",
             "GDX",
             "EFA",
             "XLF"
             )
tickers <- sort(tickers)
ticker.returns = lapply(tickers, function(tickers) {
  dailyReturn(na.omit(getSymbols(tickers,
                                   src="yahoo",
                                   from="2011-01-01",
                                   to="2019-01-01",
                                   auto.assign=FALSE)))
})

df <- as.data.frame(do.call(merge.xts, ticker.returns))
names(df) <- tickers
df <- cbind(date = rownames(df), df)
dim(df)
any(is.na(df))
```
```{r}
ticker.prices = lapply(tickers, function(tickers) {
  getSymbols(tickers,
             src="yahoo",
             from="2011-01-01",
             to="2019-01-01",
             auto.assign=FALSE)
})
prices.df <- as.data.frame(do.call(merge.xts, lapply(ticker.prices, Cl)))
names(prices.df) <- tickers
prices.df <- cbind(date = rownames(prices.df), prices.df)
dim(df)
any(is.na(prices.df))
```
```{r}
head(df)
tail(df)
```
```{r}
train.index <- round(0.7505 * nrow(df))
train.df <- df[1:train.index,]
test.df <- df[-(1:train.index),]

train.prices.df <- prices.df[1:train.index,]
test.prices.df <- prices.df[-(1:train.index),]

nrow(train.df)
nrow(test.df)
tail(train.df)
head(test.df)
```
```{r}
fh.train.df <- train.df[1:6]
sh.train.cols <- c(1, 7:11)
sh.train.df <- train.df[sh.train.cols]

melted.fh.train.df <- melt(fh.train.df, id="date")
melted.sh.train.df <- melt(sh.train.df, id="date")

melted.train.prices.df <- melt(train.prices.df, id="date")
tail(train.prices.df)
```
```{r}
head(train.prices.df)
date <- train.prices.df[, 1]

div.prices.df <- data.frame(lapply(train.prices.df[, 2:11], function(x) x/x[1]))
div.prices.df <- cbind(date, div.prices.df)
melted.div.prices.df <- melt(div.prices.df, id="date")
tail(div.prices.df)
```
```{r, fig.width=11, fig.height=4}
ggplot(data=melted.fh.train.df, aes(x=as.Date(melted.fh.train.df$date), y=melted.fh.train.df$value,
                           group=melted.fh.train.df$variable, color=melted.fh.train.df$variable)) +
geom_line(alpha=0.7) +
xlab("Date") + ylab("Return") + scale_y_continuous(labels=percent) +
scale_color_discrete("ETF") + ggtitle("ETF Daily Returns over Training Period (Jan 2011 - Dec 2016), pt. 1") +
ggsave("etf_rets_train_pt1.pdf", width=8, height=4)
```
```{r, fig.width=11, fig.height=4}
ggplot(data=melted.sh.train.df, aes(x=as.Date(melted.sh.train.df$date), y=melted.sh.train.df$value,
                           group=melted.sh.train.df$variable, color=melted.sh.train.df$variable)) +
geom_line(alpha=0.7) +
xlab("Date") + ylab("Return") + scale_y_continuous(labels=percent) +
scale_color_discrete("ETF") + ggtitle("ETF Daily Returns over Training Period (Jan 2011 - Dec 2016), pt. 2") +
ggsave("etf_rets_train_pt2.pdf", width=8, height=4)
```
```{r, fig.width=11, fig.height=4}
ggplot(data=melted.train.prices.df, aes(x=as.Date(melted.train.prices.df$date), y=melted.train.prices.df$value,
                           group=melted.train.prices.df$variable, color=melted.train.prices.df$variable)) +
geom_line() +
xlab("Date") + ylab("Price ($)") +
scale_color_discrete("ETF") + ggtitle("ETF Performance over Training Period (Jan 2011 - Dec 2016)") +
ggsave("etf_perf_train.pdf", width=8, height=4)
```
```{r, fig.width=11, fig.height=4}
ggplot(data=melted.div.prices.df, aes(x=as.Date(melted.div.prices.df$date), y=melted.div.prices.df$value,
                           group=melted.div.prices.df$variable, color=melted.div.prices.df$variable)) +
geom_line() +
xlab("Date") + ylab("Return") + scale_y_continuous(labels=percent) +
scale_color_discrete("ETF") + ggtitle("ETF Performance over Training Period (Jan 2011 - Dec 2016) - Normalised") +
ggsave("etf_perf_train_norm.pdf", width=8, height=4)
```
```{r}
etfs <- names(div.prices.df[, 2:11])
setdiff(etfs, "EFA")

multiplyColumns <- function(name1, name2, df){
    (df[, name1] - df[, name2])^2
}

combinations <- expand.grid(names(div.prices.df[, 2:11]), names(div.prices.df[, 2:11]), stringsAsFactors = FALSE)
names4result <- paste(combinations[,1], combinations[,2], sep = "_")

combinations[,1]

result <- as.data.frame(mapply(multiplyColumns, combinations[,1], combinations[,2], div.prices.df[, 2:11]))
names(result) <- names4result
result
```
```{r}
distances <- proxy::dist(div.prices.df[, 2:11], method = "euclidean", by_rows = F)
distances
```
```{r}
a <- c(2, 3, 4)
b <- c(5, 4, 3)
c <- c(1, 2, 3)

test <- data.frame(a, b, c)
test
test.dist <- proxy::dist(test, method = "manhattan", by_rows = F)
test.dist
sapply(test, y = test$a, function(x, y) MSE(x, y))
qq <- mapply(MSE, test$a, test$b) / length(test)
sum(qq)/length(test)
```
```{r}
norm.prices.df <- div.prices.df[, 2:11]
distances <- data.frame(rbind(sapply(norm.prices.df, y = norm.prices.df$EEM, function(x, y) MSE(x, y))))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$EFA, function(x, y) MSE(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$GDX, function(x, y) MSE(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$GLD, function(x, y) MSE(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$IVV, function(x, y) MSE(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$QQQ, function(x, y) MSE(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$VEA, function(x, y) MSE(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$VOO, function(x, y) MSE(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$VTI, function(x, y) MSE(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$XLF, function(x, y) MSE(x, y)))
dist.matrix <- distances
rownames(dist.matrix) <- colnames(dist.matrix)
dist.matrix[upper.tri(dist.matrix,diag=T)] <- NA
dist.matrix <- dist.matrix[2:10, 1:9]
dist.matrix
min(dist.matrix, na.rm=T)
```