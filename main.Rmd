---
title: "R Notebook"
output: html_notebook
---
```{r}
library(quantmod)
library(ggplot2)
library(scales)
library(reshape2)
library(proxy)
library(MLmetrics)
library(BBmisc)
```
```{r}
tickers <- c("QQQ",
             "GLD",
             "EEM",
             "VTI",
             "VEA",
             "GDX",
             "XLF"
             )
tickers <- sort(tickers)
ticker.returns = lapply(tickers, function(tickers) {
  dailyReturn(na.omit(getSymbols(tickers,
                                   src="yahoo",
                                   from="2011-01-01",
                                   to="2019-01-01",
                                   auto.assign=FALSE)))
})

df <- as.data.frame(do.call(merge.xts, ticker.returns))
names(df) <- tickers
df <- cbind(date = rownames(df), df)
dim(df)
any(is.na(df))
```
```{r}
ticker.prices = lapply(tickers, function(tickers) {
  getSymbols(tickers,
             src="yahoo",
             from="2011-01-01",
             to="2019-01-01",
             auto.assign=FALSE)
})
prices.df <- as.data.frame(do.call(merge.xts, lapply(ticker.prices, Cl)))
names(prices.df) <- tickers
prices.df <- cbind(date = rownames(prices.df), prices.df)
dim(df)
any(is.na(prices.df))
```
```{r}
head(df)
tail(df)
```
```{r}
train.index <- round(0.7505 * nrow(df))
train.df <- df[1:train.index,]
test.df <- df[-(1:train.index),]

train.prices.df <- prices.df[1:train.index,]
test.prices.df <- prices.df[-(1:train.index),]

nrow(train.df)
nrow(test.df)
tail(train.df)
head(test.df)
```
```{r}
fh.train.df <- train.df[1:4]
sh.train.cols <- c(1, 5:length(colnames(df)))
sh.train.df <- train.df[sh.train.cols]

melted.fh.train.df <- melt(fh.train.df, id="date")
melted.sh.train.df <- melt(sh.train.df, id="date")

melted.train.prices.df <- melt(train.prices.df, id="date")
tail(train.prices.df)
```
```{r}
date <- train.prices.df[, 1]

div.prices.df <- data.frame(lapply(train.prices.df[, 2:length(colnames(df))], function(x) x/x[1]))
div.prices.df <- cbind(date, div.prices.df)
melted.div.prices.df <- melt(div.prices.df, id="date")
tail(div.prices.df)
```
```{r, fig.width=11, fig.height=4}
ggplot(data=melted.fh.train.df, aes(x=as.Date(melted.fh.train.df$date), y=melted.fh.train.df$value,
                           group=melted.fh.train.df$variable, color=melted.fh.train.df$variable)) +
geom_line(alpha=0.7) +
xlab("Date") + ylab("Return") + scale_y_continuous(labels=percent) +
scale_color_discrete("ETF") + ggtitle("ETF Daily Returns over Training Period (Jan 2011 - Dec 2016), pt. 1") +
ggsave("etf_rets_train_pt1.pdf", width=8, height=4)
```
```{r, fig.width=11, fig.height=4}
ggplot(data=melted.sh.train.df, aes(x=as.Date(melted.sh.train.df$date), y=melted.sh.train.df$value,
                           group=melted.sh.train.df$variable, color=melted.sh.train.df$variable)) +
geom_line(alpha=0.7) +
xlab("Date") + ylab("Return") + scale_y_continuous(labels=percent) +
scale_color_discrete("ETF") + ggtitle("ETF Daily Returns over Training Period (Jan 2011 - Dec 2016), pt. 2") +
ggsave("etf_rets_train_pt2.pdf", width=8, height=4)
```
```{r, fig.width=11, fig.height=4}
ggplot(data=melted.train.prices.df, aes(x=as.Date(melted.train.prices.df$date), y=melted.train.prices.df$value,
                           group=melted.train.prices.df$variable, color=melted.train.prices.df$variable)) +
geom_line() +
xlab("Date") + ylab("Price ($)") +
scale_color_discrete("ETF") + ggtitle("ETF Performance over Training Period (Jan 2011 - Dec 2016)") +
ggsave("etf_perf_train.pdf", width=8, height=4)
```
```{r, fig.width=11, fig.height=4}
ggplot(data=melted.div.prices.df, aes(x=as.Date(melted.div.prices.df$date), y=melted.div.prices.df$value,
                           group=melted.div.prices.df$variable, color=melted.div.prices.df$variable)) +
geom_line() +
xlab("Date") + ylab("Return") + scale_y_continuous(labels=percent) +
scale_color_discrete("ETF") + ggtitle("ETF Performance over Training Period (Jan 2011 - Dec 2016) - Normalised") +
ggsave("etf_perf_train_norms.jpg", width=8, height=4)
```
```{r}
spread <- function(x, y) {
  return(x - y)
}

ssd <- function (x, y) {
  return(mean(spread(x, y)^2))
}

hist.mean <- function(x, y) {
  return(mean(x - y))
}

sample.variance <- function(x, y) {
  return(ssd(x, y) - (hist.mean(x, y))^2)
}

hist.std <- function(x, y) {
  return(sqrt(sample.variance(x, y)))
}

norm.prices.df <- div.prices.df[, 2:length(colnames(df))]
distances <- data.frame(rbind(sapply(norm.prices.df, y = norm.prices.df$EEM, function(x, y) ssd(x, y))))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$GDX, function(x, y) ssd(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$GLD, function(x, y) ssd(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$QQQ, function(x, y) ssd(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$VEA, function(x, y) ssd(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$VTI, function(x, y) ssd(x, y)))
distances <- rbind(distances, sapply(norm.prices.df, y = norm.prices.df$XLF, function(x, y) ssd(x, y)))
dist.matrix <- distances
rownames(dist.matrix) <- colnames(dist.matrix)
dist.matrix[upper.tri(dist.matrix,diag=T)] <- NA
dist.matrix <- dist.matrix[2:length(rownames(dist.matrix)), 1:length(rownames(dist.matrix))-1]
max(dist.matrix, na.rm=T)
min(dist.matrix, na.rm=T)
dist.matrix
dist.matrix <- cbind(var2 = rownames(dist.matrix), dist.matrix)
melted.dist.mat <- melt(dist.matrix, na.rm = T)
melted.dist.mat$value <- rescale(melted.dist.mat$value, to=c(0,1))
```
```{r, fig.width=7, fig.height=4}
ggplot(data = melted.dist.mat, aes(x=var2, y=variable, fill=value)) + 
  geom_tile(color = "white") + geom_text(aes(var2, variable, label = value), color = "black", size = 2, parse = T) +
  xlab("ETF") + ylab("ETF") + theme_minimal() + scale_fill_gradient(low = "lightblue", high = "red", name="Distance") +
  ggtitle("ETF Distance Matrix")
ggsave("dist_matrix.pdf", width=7, height=4)
```
```{r, fig.width=11, fig.height=4}
pair.prices.df <- data.frame(train.prices.df$EEM, train.prices.df$GLD)
pair.prices.df <- data.frame(lapply(pair.prices.df, function(x) x/x[1]))
eem.gld.spread <- spread(pair.prices.df$train.prices.df.EEM, pair.prices.df$train.prices.df.GLD)
gld.eem.spread <- spread(pair.prices.df$train.prices.df.GLD, pair.prices.df$train.prices.df.EEM)
pair.prices.df <- cbind(pair.prices.df, train.prices.df$date, eem.gld.spread, gld.eem.spread)
colnames(pair.prices.df) <- c("EEM", "GLD", "date", "S(EEM, GLD)", "S(GLD, EEM)")
pair.prices.df <- data.frame(pair.prices.df$date, pair.prices.df$EEM, pair.prices.df$GLD, pair.prices.df$`S(GLD, EEM)`)
colnames(pair.prices.df) <- c("date", "EEM", "GLD", "S(GLD, EEM)")
# pair.pos <- spread(div.prices.df$GLD, div.prices.df$EEM) >= hist.mean(div.prices.df$GLD, div.prices.df$EEM) + (0.0*hist.std(div.prices.df$GLD, div.prices.df$EEM))
# pair.pos <- pair.pos * 0.25
eem.long <- spread(div.prices.df$GLD, div.prices.df$EEM) >= 0
gld.long <- spread(div.prices.df$GLD, div.prices.df$EEM) <= 0 
eem.long <- eem.long * 0.5
eem.long <- eem.long - 0.25
gld.long <- gld.long * 0.5
gld.long <- gld.long - 0.25
pair.prices.df <- cbind(pair.prices.df, eem.long, gld.long)
colnames(pair.prices.df) <- c("date", "EEM", "GLD", "S(GLD, EEM)", "Long EEM", "Long GLD")
melted.pair <- melt(pair.prices.df, id="date")

ggplot(data=melted.pair, aes(x=as.Date(melted.pair$date), y=melted.pair$value,
                           group=melted.pair$variable, color=melted.pair$variable)) +
geom_line() +
xlab("Date") + ylab("Return") + scale_y_continuous(labels=percent) +
scale_color_discrete("ETF") + ggtitle("Performance of EEM and GLD ETFs over Training Period (Jan 2011 - Dec 2016) - Normalised")
ggsave("pair_perf_train_norm.pdf", width=8, height=4)
```
```{r}
tail(pair.prices.df)
```
```{r, fig.width=11, fig.height=4}
spread.df <- data.frame(pair.prices.df$date, pair.prices.df$`S(GLD, EEM)`)
colnames(spread.df) <- c("date", "S(GLD, EEM)")
melted.spread <- melt(spread.df, id="date")
ggplot(data=melted.spread, aes(x=as.Date(melted.spread$date), y=melted.spread$value,
                           group=melted.spread$variable, color=melted.spread$variable)) +
  geom_line() +
xlab("Date") + ylab("Distance") + scale_y_continuous(labels=percent) +
scale_color_discrete("ETF") + ggtitle("Spread between EEM and GLD ETFs over Training Period (Jan 2011 - Dec 2016)")
ggsave("spread.pdf", width=8, height=4)
```

```{r}
a <- c(2, 3, 4, 3, 3)
b <- c(5, 4, 3, 4, 6)
c <- c(1, 2, 3, 3, 3)
test <- data.frame(a, b, c)
spread(test$b, test$c)
ssd(test$b, test$c)
hist.mean(test$b, test$c)
sample.variance(test$b, test$c)
hist.std(test$b, test$c)

plot(spread(test$b, test$a))
spread(test$a, test$b) >= hist.mean(test$a, test$b) + (2*hist.std(test$a, test$b)) 
hist.mean(test$a, test$b) + (2*hist.std(test$a, test$b)) 
spread(test$a, test$b) <= hist.mean(test$a, test$b) - (2*hist.std(test$a, test$b)) 
hist.mean(test$a, test$b) - (2*hist.std(test$a, test$b)) 

spread(div.prices.df$EEM, div.prices.df$GLD)
spread(div.prices.df$EEM, div.prices.df$GLD) >= hist.mean(div.prices.df$EEM, div.prices.df$GLD) + (2*hist.std(div.prices.df$EEM, div.prices.df$GLD)) 
hist.mean(div.prices.df$EEM, div.prices.df$GLD) + (2*hist.std(div.prices.df$EEM, div.prices.df$GLD)) 
spread(div.prices.df$EEM, div.prices.df$GLD) <= hist.mean(div.prices.df$EEM, div.prices.df$GLD) - (2*hist.std(div.prices.df$EEM, div.prices.df$GLD))
hist.mean(div.prices.df$EEM, div.prices.df$GLD) - (2*hist.std(div.prices.df$EEM, div.prices.df$GLD)) 

spread(div.prices.df$GLD, div.prices.df$EEM) >= hist.mean(div.prices.df$GLD, div.prices.df$EEM) + (0.1*hist.std(div.prices.df$GLD, div.prices.df$EEM)) 
spread(div.prices.df$GLD, div.prices.df$EEM) <= hist.mean(div.prices.df$GLD, div.prices.df$EEM) - (2*hist.std(div.prices.df$GLD, div.prices.df$EEM))
```
```{r}

```